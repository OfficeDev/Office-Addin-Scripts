# steps:
# - script: |
#     node -v
#     npm -v
#     npm ci
#     npm run build -- --stream --concurrency 1
#   displayName: Build (script)
#   env:
#     LERNA_DEBUG: "*"
#     NPM_CONFIG_LOGLEVEL: "verbose"

# steps:
# - script: |
#     npx lerna list
#     npx lerna run build --stream --concurrency 1
#   displayName: Build (script)

steps:
- script: |
    echo Node and NPM versions:
    node -v
    npm -v
    if errorlevel 1 (
        echo npm list failed with exit code %ERRORLEVEL%
        exit /b 0
    )
    npx lerna -v
    if errorlevel 1 (
        echo npm list failed with exit code %ERRORLEVEL%
        exit /b 0
    )
    echo.
    echo Check lerna.json:
    type lerna.json
    echo.
    echo Lerna list output:
    npx lerna list --no-ci --loglevel verbose
    if errorlevel 1 (
        echo npm list failed with exit code %ERRORLEVEL%
        exit /b 0
    )
    echo.
    echo Lerna list with --all:
    npx lerna list --all --no-ci
    if errorlevel 1 (
        echo npm list failed with exit code %ERRORLEVEL%
        exit /b 0
    )
    echo.
    echo Check if lerna can read package.json by listing package names:
    npx lerna ls --no-ci --json
    if errorlevel 1 (
        echo npm list failed with exit code %ERRORLEVEL%
        exit /b 0
    )
    echo.
    echo Try running build on a specific package:
    npx lerna run build --scope office-addin-cli --no-ci --loglevel verbose
    if errorlevel 1 (
        echo npm list failed with exit code %ERRORLEVEL%
        exit /b 0
    )
    echo.
    echo === Workaround: Use npm workspaces directly ===
    npm run build
    if errorlevel 1 (
        echo npm list failed with exit code %ERRORLEVEL%
        exit /b 0
    )
  displayName: Build (script) with debugging